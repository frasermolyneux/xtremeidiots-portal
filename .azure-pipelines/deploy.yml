trigger: none

pool: 'Dedicated'

resources:
  pipelines:
  - pipeline: xtremeidiots-portal.Validate
    source: xtremeidiots-portal.Validate
    trigger: true

stages: 
- stage: Build
  jobs:
  - template: templates/build-web-app.yml
    parameters: 
      jobName: 'BuildAdminWebApp'
      projectName: 'admin-webapp'
      nugetConfigPath: './src/nuget.config'
      publishArtifact: true

  - template: templates/build-function-app.yml
    parameters: 
      jobName: 'BuildEventsFunctionApp'
      projectName: 'events-func'
      publishArtifact: true

  - template: templates/build-function-app.yml
    parameters: 
      jobName: 'BuildIngestFunctionApp'
      projectName: 'ingest-func'
      publishArtifact: true

  - template: templates/build-web-app.yml
    parameters: 
      jobName: 'BuildRepositoryWebApi'
      projectName: 'repository-webapi'
      nugetConfigPath: './src/nuget.config'
      publishArtifact: true

  - template: templates/build-function-app.yml
    parameters: 
      jobName: 'BuildRepositoryFunctionApp'
      projectName: 'repository-func'
      nugetConfigPath: './src/nuget.config'
      publishArtifact: true

  - template: templates/build-function-app.yml
    parameters: 
      jobName: 'BuildSyncFunctionApp'
      projectName: 'sync-func'
      publishArtifact: true

  - template: templates/build-web-app.yml
    parameters: 
      jobName: 'BuildServersWebApi'
      projectName: 'servers-webapi'
      publishArtifact: true

  - template: templates/build-sql-database.yml
    parameters:
      publishArtifact: true

- stage: DeployPrdPlatform

  jobs:
  - job: DeployAADResources
    steps:
      - task: AzureCLI@2
        displayName: Create Database AAD Groups
        inputs:
          azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          arguments: "'prd' 'uksouth'"
          scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateDatabaseAADGroups.ps1'

      - task: AzureCLI@2
        displayName: Create Application Registrations
        inputs:
          azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
          scriptType: 'pscore'
          scriptLocation: 'scriptPath'
          scriptPath: '$(Build.sourcesDirectory)/.azure-pipelines/scripts/CreateAppRegistrations.ps1'

      #- task: AzureCLI@2
      #  displayName: Create Application Credentials
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/appRegistrationCredentials.ps1'

#  - job: DeployPlatformBicep
#    dependsOn: [DeployAADResources]
    #steps:
      #- task: AzureCLI@2
      #  displayName: DeployPlatformBicep
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'inlineScript'
      #    inlineScript: |
      #      $sqlAdminPassword = (az keyvault secret show --name "sql-portal-prd-$(location)-01-admin-password" --vault-name "kv-portal-prd-$(location)-01" --query 'value') | ConvertFrom-Json
      #      $sqlAdminGroupOid = (az ad group show --group "sg-sql-portal-prd-admins" --query 'id')  | ConvertFrom-Json

      #      az deployment sub create `
      #        --template-file bicep/platform.bicep `
      #        --location $(location) `
      #        --parameters @params/platform.prd.json `
      #          parLocation=$(location) `
      #          parEnvironment=prd `
      #          parSqlAdminGroupOid=$sqlAdminGroupOid `
      #          parSqlAdminPassword=$sqlAdminPassword

#  - job: DeployPlatformPermissions
#    dependsOn: [DeployPlatformBicep]
    #steps:
      #- task: AzureCLI@2
      #  displayName: SetDeployPrincipalPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    addSpnToEnvironment: true
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetDeployPrincipalPermissions.ps1'

      #- task: AzureCLI@2
      #  displayName: CreateSqlServerRoleAssignment
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: '"sql-portal-prd-$(location)-01" "rg-portal-prd-$(location)-01"'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/CreateSqlServerRoleAssignment.ps1'

#- stage: DeployPrdServices

#  jobs:
#  - job: DeployServicesBicep
   #steps:
    #- task: AzureCLI@2
    #  displayName: DeployServicesBicep
    #  inputs:
    #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
    #    scriptType: 'pscore'
    #    scriptLocation: 'inlineScript'
    #    inlineScript: |
    #      $eventsApiAppName = "portal-events-api-prd"
    #      $repositoryApiName = "portal-repository-api-prd"
    #      $serversApiName = "portal-servers-api-prd"

    #      $repositoryApiAppId = (az ad app list --filter "displayName eq '$repositoryApiName'" --query '[].appId') | ConvertFrom-Json
    #      $eventsApiAppId = (az ad app list --filter "displayName eq '$eventsApiAppName'" --query '[].appId') | ConvertFrom-Json
    #      $serversApiAppId = (az ad app list --filter "displayName eq '$serversApiName'" --query '[].appId') | ConvertFrom-Json

    #      az deployment group create --resource-group "rg-portal-prd-$(location)-01" `
    #          --template-file bicep/services.bicep `
    #          --parameters @params/services.prd.json `
    #          parLocation=$(location) `
    #          parEnvironment=prd `
    #          parEventsApiAppId=$eventsApiAppId `
    #          parRepositoryApiAppId=$repositoryApiAppId `
    #          parServersApiAppId=$serversApiAppId 

 # - job: DeployServicesPermissions
 #   dependsOn: [DeployServicesBicep]
    #steps:
      #- task: AzureCLI@2
      #  displayName: SetIngestApiFuncAppPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetIngestApiFuncAppPermissions.ps1'

      #- task: AzureCLI@2
      #  displayName: SetRepositoryApiAppPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetRepositoryApiAppPermissions.ps1'

      #- task: AzureCLI@2
      #  displayName: SetRepositoryAppPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetRepositoryAppPermissions.ps1'

      #- task: AzureCLI@2
      #  displayName: SetServersWebApiPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetServersWebApiPermissions.ps1'

      #- task: AzureCLI@2
      #  displayName: SetAdminWebAppPermissions
      #  inputs:
      #    azureSubscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
      #    scriptType: 'pscore'
      #    scriptLocation: 'scriptPath'
      #    arguments: 'prd'
      #    scriptPath: '$(Build.sourcesDirectory)/scripts/SetAdminWebAppPermissions.ps1'

#- stage: DeployPrdArtifacts

  #jobs:
  #- template: templates/deploy-sql-database.yml
  #  parameters:
  #    jobName: DeploySqlDatabase
  #    serverName: "sql-portal-prd-$(location)-01.database.windows.net"
  #    databaseName: 'portaldb'
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
  #    sqlCmdArgs: '/Variables:env=prd'

  #- template: templates/deploy-web-app.yml
  #  parameters:
  #    dependsOn: ['DeploySqlDatabase']
  #    projectName: repository-webapi
  #    jobName: DeployRepositoryWebApi
  #    webAppName: "webapi-repository-portal-prd-$(location)-01"
  #    webAppNameResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
  #    blueGreenDeploy: true

  #- template: templates/deploy-function-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: repository-func
  #    jobName: DeployRepositoryFunctionApp
  #    functionAppName: "fn-repository-portal-prd-$(location)-01"
  #    functionAppResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'

  #- template: templates/deploy-function-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: ingest-func
  #    jobName: DeployIngestFunctionApp
  #    functionAppName: "fn-ingest-portal-prd-$(location)-01"
  #    functionAppResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'

  #- template: templates/deploy-function-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: events-func
  #    jobName: DeployEventsFunctionApp
  #    functionAppName: "fn-events-portal-prd-$(location)-01"
  #    functionAppResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
  #    blueGreenDeploy: true

  #- template: templates/deploy-function-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: sync-func
  #    jobName: DeploySyncFunctionApp
  #    functionAppName: "fn-sync-portal-prd-$(location)-01"
  #    functionAppResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
#
  #- template: templates/deploy-web-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: servers-webapi
  #    jobName: DeployServersWebApi
  #    webAppName: "webapi-servers-portal-prd-uksouth-01"
  #    webAppNameResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
  #    blueGreenDeploy: true

  #- template: templates/deploy-web-app.yml
  #  parameters:
  #    dependsOn: ['DeployRepositoryWebApi']
  #    projectName: admin-webapp
  #    jobName: DeployAdminWebApp
  #    webAppName: "webapp-admin-portal-prd-$(location)-01"
  #    webAppNameResourceGroup: "rg-portal-prd-$(location)-01"
  #    subscription: 'spn-ado-XtremeIdiots-Public-xtremeidiots-portal-prd'
  #    blueGreenDeploy: true
@{
    ViewData["Title"] = "Migrate Legacy Users";
}

<row class="row">
    <div class="container-fluid">
        <div class="card card-header">
            @ViewData["Title"]
        </div>
        <div class="card card-body">
            <div class="progress">
                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="@ViewData["TotalEntries"]"></div>
            </div>
            <div id="progress-text"></div>
        </div>
    </div>
</row>

<row class="row">
    <div class="container-fluid" style="padding-top: 40px">
        <div class="card card-header">
            Log
        </div>
        <div class="card card-body">
            <textarea id="result" rows="20" disabled="disabled"></textarea>
        </div>
    </div>
</row>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function() {

            var totalEntries = @ViewData["TotalEntries"];
            var progress = 0;

            function runProcess() {
                var take;
                if ((progress + 10) > totalEntries) {
                    take = totalEntries - progress;
                } else {
                    take = 10;
                }

                $.ajax({
                    url: "/User/ProcessMigrateUsers",
                    data: {
                        progress: progress,
                        take: take
                    },
                    dataType: 'json',
                    success: function(result) {
                        progress = result.progress;
                        var percentage = progress / totalEntries * 100;

                        $('#progress-bar').attr('aria-valuenow', progress);
                        $('#progress-bar').attr('style', 'width:' + percentage + "%");
                        $('#progress-text').text('Processed ' + progress + ' entries out of ' + totalEntries);
                        $("#result").append(result.log);

                        if (progress !== totalEntries) {
                            runProcess();
                        }
                    }
                });
            }

            runProcess();

        })
    </script>
}